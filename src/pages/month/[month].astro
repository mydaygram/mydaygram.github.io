---
import Layout from "@/layouts/Layout.astro";
import { getPageList } from "@/pages/api/post/list";

const month = Number((Astro.params as any).month);

const monthNames = ['JANUARY', 'FEBRUARY', 'MARCH', 'APRIL', 'MAY', 'JUNE', 
                   'JULY', 'AUGUST', 'SEPTEMBER', 'OCTOBER', 'NOVEMBER', 'DECEMBER'];

const all = await getPageList();
const posts = all.filter((v) => {
  const date = new Date(v.createTime);
  return date.getMonth() + 1 === month;
});

// Get years that have posts in this month
const yearsWithPosts = [...new Set(posts.map(p => new Date(p.createTime).getFullYear()))].sort((a, b) => b - a);

export const getStaticPaths = async () => {
  const all = await getPageList();
  const months = new Set<number>();
  all.forEach(p => {
    const date = new Date(p.createTime);
    months.add(date.getMonth() + 1);
  });
  return Array.from(months).map((m) => ({
    params: {
      month: m.toString(),
    },
  }));
};

// Helper function to get day of week
function getDayOfWeek(dateStr: Date): { day: string; isSunday: boolean } {
  const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
  const date = new Date(dateStr);
  const dayIndex = date.getDay();
  return {
    day: days[dayIndex],
    isSunday: dayIndex === 0
  };
}

function getDayNumber(dateStr: Date): string {
  const date = new Date(dateStr);
  return date.getDate().toString();
}
---

<script>
  import { mount } from "@/components/RelativeTime";
  mount("data-acc-time");
</script>

<Layout title={monthNames[month - 1]}>
  <main>
    <div class="content">
      <!-- Month header -->
      <div class="month-header">
        <a href="/" class="back-link">‚Üê Back</a>
        <h1 class="month-title">{monthNames[month - 1]}</h1>
        <div class="post-count">{posts.length} posts</div>
      </div>

      <!-- Year filter -->
      <div class="year-filter">
        {yearsWithPosts.map((year) => (
          <a href={`/year/${year}?month=${month}`} class="year-item">
            {year}
          </a>
        ))}
      </div>

      <!-- Posts list -->
      {
        posts.map((item) => {
          const { day, isSunday } = getDayOfWeek(item.createTime);
          const dayNum = getDayNumber(item.createTime);
          return (
            <a href={`/post/${item.id}`} class="daygram-entry block no-underline">
              <div class="daygram-entry-date">
                <span class={`daygram-entry-day ${isSunday ? 'sunday' : ''}`}>{day}</span>
                <span class="daygram-entry-number">{dayNum}</span>
              </div>
              <div class="daygram-entry-content">
                <div class="daygram-entry-title">{item.title}</div>
                <div class="daygram-entry-intro">{item.intro}</div>
              </div>
            </a>
          );
        })
      }
    </div>
  </main>
</Layout>

<style>
  .month-header {
    padding: 20px 0;
    text-align: center;
    border-bottom: 1px solid #504F4B;
    margin-bottom: 20px;
  }

  .back-link {
    display: inline-block;
    margin-bottom: 10px;
    color: #504F4B;
    text-decoration: none;
    font-size: 14px;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  @media (prefers-color-scheme: dark) {
    .back-link {
      color: #E8E6E1;
    }
  }

  .month-title {
    font-size: 28px;
    font-weight: bold;
    color: #504F4B;
    margin: 0 0 5px 0;
  }

  @media (prefers-color-scheme: dark) {
    .month-title {
      color: #E8E6E1;
    }
  }

  .post-count {
    font-size: 14px;
    color: #A6A6A2;
  }

  .year-filter {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .year-item {
    padding: 5px 15px;
    border: 1px solid #504F4B;
    border-radius: 20px;
    color: #504F4B;
    text-decoration: none;
    font-size: 14px;
  }

  .year-item:hover {
    background-color: rgba(80, 79, 75, 0.1);
  }

  @media (prefers-color-scheme: dark) {
    .year-item {
      color: #E8E6E1;
      border-color: #504F4B;
    }
    .year-item:hover {
      background-color: rgba(232, 230, 225, 0.1);
    }
  }
</style>
