---
import Layout from "../layouts/Layout.astro";
import Pagination from "../components/Pagination.astro";
import type { ShortPageData } from "../shared/type";
import config from "urodele.config";

interface Props {
  posts: ShortPageData[];
  page: number;
  pages: number;
}

const { posts, page, pages } = Astro.props;

// Helper function to get day of week
function getDayOfWeek(dateStr: Date): { day: string; isSunday: boolean } {
  const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
  const date = new Date(dateStr);
  const dayIndex = date.getDay();
  return {
    day: days[dayIndex],
    isSunday: dayIndex === 0
  };
}

// Helper function to get day number
function getDayNumber(dateStr: Date): string {
  const date = new Date(dateStr);
  return date.getDate().toString();
}

// Helper function to get month info
function getMonthInfo(dateStr: Date): { num: number; name: string } {
  const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 
                   'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
  const date = new Date(dateStr);
  return {
    num: date.getMonth() + 1,
    name: months[date.getMonth()]
  };
}

// Helper function to get year
function getYearNum(dateStr: Date): number {
  const date = new Date(dateStr);
  return date.getFullYear();
}

// Calculate month range from current page posts
function getMonthRange(postsList: ShortPageData[]): { display: string; link: string } {
  if (postsList.length === 0) {
    const now = new Date();
    const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 
                   'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
    return {
      display: months[now.getMonth()],
      link: `/month/${now.getMonth() + 1}`
    };
  }

  const months = postsList.map(p => getMonthInfo(p.createTime));
  const uniqueMonths = [...new Map(months.map(m => [m.num, m])).values()];
  uniqueMonths.sort((a, b) => a.num - b.num);

  if (uniqueMonths.length === 1) {
    return {
      display: uniqueMonths[0].name,
      link: `/month/${uniqueMonths[0].num}`
    };
  } else {
    return {
      display: `${uniqueMonths[0].name} - ${uniqueMonths[uniqueMonths.length - 1].name}`,
      link: `/month/${uniqueMonths[0].num}`
    };
  }
}

// Calculate year range from current page posts
function getYearRange(postsList: ShortPageData[]): { display: string; link: string } {
  if (postsList.length === 0) {
    return {
      display: new Date().getFullYear().toString(),
      link: `/year/${new Date().getFullYear()}`
    };
  }

  const years = postsList.map(p => getYearNum(p.createTime));
  const uniqueYears = [...new Set(years)].sort((a, b) => a - b);

  if (uniqueYears.length === 1) {
    return {
      display: uniqueYears[0].toString(),
      link: `/year/${uniqueYears[0]}`
    };
  } else {
    return {
      display: `${uniqueYears[0]} - ${uniqueYears[uniqueYears.length - 1]}`,
      link: `/year/${uniqueYears[0]}`
    };
  }
}

const monthRange = getMonthRange(posts);
const yearRange = getYearRange(posts);
---

<script>
  import { mount } from "../components/RelativeTime";
  mount("data-acc-time");
</script>

<Layout title={config.head.title}>
  <!-- Daygram-style brand banner -->
  <div class="brand-banner">
    {config.head.brand}
  </div>
  
  <main>
    <div class="content">
      {
        posts.map((item) => {
          const { day, isSunday } = getDayOfWeek(item.createTime);
          const dayNum = getDayNumber(item.createTime);
          return (
            <a href={`/post/${item.id}`} class="daygram-entry block no-underline">
              <div class="daygram-entry-date">
                <span class={`daygram-entry-day ${isSunday ? 'sunday' : ''}`}>{day}</span>
                <span class="daygram-entry-number">{dayNum}</span>
              </div>
              <div class="daygram-entry-content">
                <div class="daygram-entry-title">{item.title}</div>
                <div class="daygram-entry-intro">{item.intro}</div>
              </div>
            </a>
          );
        })
      }
      <Pagination page={page} pages={pages} />
    </div>
  </main>

  <!-- Simple bottom navigation bar -->
  <nav class="simple-nav">
    <!-- Month link: shows month range of current page -->
    <a href={monthRange.link} class="simple-nav-item">
      {monthRange.display}
    </a>
    <span class="simple-nav-sep">|</span>
    <!-- Year link: shows year range of current page -->
    <a href={yearRange.link} class="simple-nav-item">
      {yearRange.display}
    </a>
    <!-- Add new entry link -->
    <a href="/edit?new" class="simple-nav-plus">+</a>
    <!-- Tags link -->
    <a href="/tag" class="simple-nav-item">Tags</a>
  </nav>
</Layout>

<style>
  .simple-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 50px;
    background-color: #F2F1ED;
    border-top: 1px solid #504F4B;
    display: flex;
    align-items: center;
    justify-content: space-around;
    padding: 0 20px;
    z-index: 100;
  }

  @media (prefers-color-scheme: dark) {
    .simple-nav {
      background-color: #2A2927;
      border-top-color: #504F4B;
    }
  }

  .simple-nav-item {
    color: #504F4B;
    text-decoration: none;
    font-size: 14px;
    font-weight: bold;
    padding: 10px 15px;
  }

  .simple-nav-item:hover {
    opacity: 0.7;
  }

  @media (prefers-color-scheme: dark) {
    .simple-nav-item {
      color: #E8E6E1;
    }
  }

  .simple-nav-sep {
    color: #504F4B;
    font-size: 14px;
  }

  @media (prefers-color-scheme: dark) {
    .simple-nav-sep {
      color: #504F4B;
    }
  }

  .simple-nav-plus {
    width: 40px;
    height: 40px;
    background-color: #504F4B;
    color: #F2F1ED;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    font-size: 24px;
    font-weight: bold;
  }

  .simple-nav-plus:hover {
    opacity: 0.8;
  }

  @media (prefers-color-scheme: dark) {
    .simple-nav-plus {
      background-color: #E8E6E1;
      color: #2A2927;
    }
  }
</style>
